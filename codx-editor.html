
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link rel="icon" type="image/png" href="cx.png">
<title>CodX Editor</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  :root {
    /* Dark mode colors (default) */
    --bg-primary: #000000;
    --bg-secondary: #1E1E1E;
    --bg-tertiary: #2C2C2C;
    --text-primary: #ffffff;
    --text-secondary: #aaaaaa;
    --text-muted: #888888;
    --accent-color: #4CAF50;
    --accent-hover: #45a049;
    --border-color: #333333;
    --divider-color: #333333;
    --console-bg: #000000;
    --console-text: #00ff00;
    --preview-bg: #ffffff;
    --preview-text: #000000;
  }

  body.light {
    /* Light mode colors */
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e0e0e0;
    --text-primary: #000000;
    --text-secondary: #666666;
    --text-muted: #999999;
    --accent-color: #2196F3;
    --accent-hover: #1976D2;
    --border-color: #cccccc;
    --divider-color: #cccccc;
    --console-bg: #f8f8f8;
    --console-text: #333333;
    --preview-bg: #ffffff;
    --preview-text: #000000;
  }

  body {
    margin: 0;
    font-family: Arial, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
    color: var(--text-primary);
    overflow: hidden;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  header {
    background: var(--bg-secondary);
    color: var(--text-primary);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    font-size: 1.2em;
    gap: 10px;
    transition: background-color 0.3s ease;
    flex-wrap: wrap;
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--text-muted);
    transition: 0.4s;
    border-radius: 24px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 18px; width: 18px;
    left: 3px; bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }
  input:checked + .slider { background-color: var(--accent-color); }
  input:checked + .slider:before { transform: translateX(26px); }

  .theme-toggle {
    margin-left: auto;
    margin-right: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .editor-container {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .editor-container.dragover {
    border: 2px dashed var(--accent-color);
  }

  .editors {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-secondary);
    min-width: 200px;
    max-width: 80%;
    width: 50%;
    transition: background-color 0.3s ease;
  }

  .tabs {
    display: flex;
    background: var(--bg-tertiary);
    transition: background-color 0.3s ease;
  }

  .tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
    font-weight: bold;
    transition: color 0.3s ease, border-color 0.3s ease;
  }

  .tab.active {
    color: var(--text-primary);
    border-bottom: 2px solid var(--accent-color);
  }

  .code-container {
    position: relative;
    display: flex;
    flex: 1;
    background: var(--bg-secondary);
    overflow: hidden;
    transition: background-color 0.3s ease;
  }

  .line-numbers {
    width: 50px;
    padding: 10px 5px 10px 0;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    text-align: right;
    user-select: none;
    font-family: monospace;
    font-size: 14px;
    line-height: 1.4;
    overflow: hidden;
    white-space: pre;
    transition: background-color 0.3s ease, color 0.3s ease;
    border-right: 1px solid var(--border-color);
  }

  .editor-wrapper {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  textarea {
    width: 100%;
    height: 100%;
    border: none;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
    line-height: 1.4;
    outline: none;
    resize: none;
    background: var(--bg-secondary);
    color: var(--text-primary);
    display: none;
    transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    position: absolute;
    top: 0;
    left: 0;
    box-sizing: border-box;
  }

  textarea.active { display: block; }

  .run-button {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 13px;
    margin: 3px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .run-button:hover { background: var(--accent-hover); }

  .btn-icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }

  .divider {
    width: 10px;
    cursor: col-resize;
    background: var(--divider-color);
    transition: background-color 0.3s ease;
  }

  .preview {
    flex: 1;
    background: var(--preview-bg);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: background-color 0.3s ease;
  }

  iframe {
    width: 100%;
    flex: 1;
    border: none;
    background: var(--preview-bg);
    color: var(--preview-text);
    transition: flex 0.3s ease;
  }

  .console-container {
    flex: none;
    height: 150px;
    border-top: 1px solid var(--border-color);
    display: none;
    transition: border-color 0.3s ease;
  }

  .console-container.show {
    display: block;
  }

  .console-output {
  width: 100%;
  height: 100%;
  background: var(--console-bg);
  color: var(--console-text);
  font-family: monospace;
  font-size: 13px;
  padding: 10px;
  overflow-y: auto;
  white-space: pre-wrap;
}

/* Custom scrollbar */
.console-output::-webkit-scrollbar {
  width: 8px;
}
.console-output::-webkit-scrollbar-thumb {
  background: var(--text-muted);
  border-radius: 4px;
}
.console-output::-webkit-scrollbar-thumb:hover {
  background: var(--accent-color);
}


  @media (max-width: 768px) {
    .editor-container { flex-direction: column; }
    .editors { width: 100% !important; max-width: 100%; height: 50vh; }
    .divider { width: 100%; height: 5px; cursor: row-resize; }
    .preview { height: 50vh; }
    .code-container { flex-direction: row; }
    .tabs { flex-wrap: wrap; }
    .theme-toggle { margin-left: 10px; margin-right: 0; }
  }

  .header-btn {
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 18px;
    cursor: pointer;
    margin-left: 10px;
    transition: color 0.3s ease;
  }

  .header-btn:hover {
    color: var(--accent-color);

#settingsModal > div::-webkit-scrollbar {
  width: 8px;
}

#settingsModal > div::-webkit-scrollbar-thumb {
  background: var(--text-muted);
  border-radius: 4px;
}

#settingsModal > div::-webkit-scrollbar-thumb:hover {
  background: var(--accent-color);
}

/* Settings input hover effects */
#settingsModal input[type="color"]:hover,
#settingsModal input[type="range"]:hover,
#settingsModal select:hover {
  opacity: 0.8;
}

/* Custom range slider styling */
#editorTextSize {
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  background: var(--bg-tertiary);
  border-radius: 5px;
  outline: none;
}

#editorTextSize::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: var(--accent-color);
  cursor: pointer;
  border-radius: 50%;
}

#editorTextSize::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: var(--accent-color);
  cursor: pointer;
  border-radius: 50%;
  border: none;
}
  }
</style>
</head>
<body>
  
<header>
  <div style="display: flex; align-items: center; gap: 8px;">
    <span>Auto-Run</span>
    <label class="switch">
      <input type="checkbox" id="autoRun" checked>
      <span class="slider"></span>
    </label>

    <span>Console</span>
    <label class="switch">
      <input type="checkbox" id="showConsole">
      <span class="slider"></span>
    </label>
  </div>
  
  <button id="collabBtn" class="run-button" style="margin-left: 20px;">
    <svg class="btn-icon" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
    <strong>COLLAB WITH FRIENDS</strong>
  </button>
  
  <button id="previewFullscreenBtn" class="run-button" title="Toggle Preview Fullscreen">
    <svg class="btn-icon" viewBox="0 0 24 24">
        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
    </svg>
    <strong>FULLSCREEN PREVIEW</strong>
  </button>

<button id="settingsBtn" class="run-button" title="Editor Settings">
  <svg class="btn-icon" viewBox="0 0 24 24">
    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
  </svg>
  <strong>SETTINGS</strong>
</button>

<!-- Settings Modal -->
<div id="settingsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
  <div style="position: relative; background-color: var(--bg-secondary); margin: auto; padding: 25px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
    
    <span id="closeSettingsBtn" style="position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: var(--text-muted); cursor: pointer; line-height: 1;">&times;</span>

    <h2 style="margin-top: 0; color: var(--text-primary);">⚙️ Editor Settings</h2>
    
    <div style="margin: 20px 0;">
      <!-- Editor Background Color -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-primary);">
          Editor Background Color:
        </label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="color" id="editorBgColor" style="width: 60px; height: 40px; cursor: pointer; border: 2px solid var(--border-color); border-radius: 4px;">
          <input type="text" id="editorBgColorText" readonly style="flex: 1; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
        </div>
      </div>

      <!-- Text Color -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-primary);">
          Text Color:
        </label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="color" id="editorTextColor" style="width: 60px; height: 40px; cursor: pointer; border: 2px solid var(--border-color); border-radius: 4px;">
          <input type="text" id="editorTextColorText" readonly style="flex: 1; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
        </div>
      </div>

      <!-- Text Size -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-primary);">
          Text Size: <span id="textSizeValue" style="color: var(--accent-color);">14px</span>
        </label>
        <input type="range" id="editorTextSize" min="10" max="24" value="14" style="width: 100%; cursor: pointer;">
      </div>

      <!-- Font Family -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-primary);">
          Font Family:
        </label>
        <select id="editorFontFamily" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; cursor: pointer; font-size: 14px;">
          <option value="monospace">Monospace (Default)</option>
          <option value="'Courier New', monospace">Courier New</option>
          <option value="'Consolas', monospace">Consolas</option>
          <option value="'Monaco', monospace">Monaco</option>
          <option value="'Lucida Console', monospace">Lucida Console</option>
          <option value="'Ubuntu Mono', monospace">Ubuntu Mono</option>
          <option value="'Roboto Mono', monospace">Roboto Mono</option>
          <option value="'Source Code Pro', monospace">Source Code Pro</option>
          <option value="'Fira Code', monospace">Fira Code</option>
        </select>
      </div>

      <!-- Preview Box -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-primary);">
          Preview:
        </label>
        <div id="settingsPreview" style="padding: 15px; border: 2px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 14px;">
          function helloWorld() {<br>
          &nbsp;&nbsp;console.log("Hello, World!");<br>
          }
        </div>
      </div>

      <!-- Action Buttons -->
      <div style="display: flex; gap: 10px; justify-content: space-between; flex-wrap: wrap;">
        <button id="applySettings" class="run-button" style="flex: 1;">
          <strong>APPLY</strong>
        </button>
        <button id="resetSettings" class="run-button" style="flex: 1; background: #ff5722;">
          <strong>RESET TO DEFAULT</strong>
        </button>
      </div>
    </div>
  </div>
</div>

  <div class="theme-toggle">
    <span><strong>🌙</strong></span>
    <label class="switch">
      <input type="checkbox" id="themeToggle">
      <span class="slider"></span>
    </label>
    <span><strong>☀️</strong></span>
  </div>

  <div>
    <b>CodX Editor</b>
  </div>
</header>

<div class="editor-container">
  <div class="editors">
    <div class="tabs">
      <div class="tab active" data-tab="html">HTML</div>
      <div class="tab" data-tab="css">CSS</div>
      <div class="tab" data-tab="js">JS</div>
      <button id="fullscreenBtn" class="header-btn"><strong>⛶ FULLSCREEN MODE</strong></button>
    </div>

    <div class="code-container">
      <div class="line-numbers" id="lineNumbers">1</div>
      <div class="editor-wrapper">
        <textarea id="htmlCode" class="active">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;CodX Editor&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Welcome to CodX Editor&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</textarea>
        <textarea id="cssCode">h1 {color: rgb(2, 255, 116);
    text-align: center;
    font-family: Arial, sans-serif;}</textarea>
        <textarea id="jsCode">console.log('Hello World from CodX!');</textarea>
      </div>
      <div id="typingIndicator" style="display: none; position: absolute; top: 5px; right: 15px; padding: 3px 8px; border-radius: 4px; font-size: 12px; color: white; transition: opacity 0.3s ease; z-index:10;"></div>
    </div>

    <div style="display: flex; gap: 5px; padding: 8px; justify-content: center; background: var(--bg-tertiary); border-top: 1px solid var(--border-color);">
      <button class="run-button" onclick="updatePreview()">
        <svg class="btn-icon" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
        <strong>RUN</strong>
      </button>
      <button class="run-button" onclick="exportAsZip()">
        <i class="fa-solid fa-file-zipper"></i>
        <strong>EXPORT ZIP FILE</strong>
      </button>
      <button class="run-button" onclick="importZip()">
        <i class="fa-solid fa-file-import"></i>
        <strong>IMPORT ZIP FILE</strong>
      </button>
      <input type="file" id="zipFileInput" accept=".zip" style="display: none;" onchange="handleZipImport(event)">
    </div>
  </div>

  <div class="divider"></div>

  <div class="preview">
    <iframe id="output"></iframe>
    <div class="console-container" id="consoleContainer">
  <div id="consoleOutput" class="console-output"></div>
</div>

  </div>
</div>

<div id="collabModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
  <div style="position: relative; background-color: var(--bg-secondary); margin: 15% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 400px; text-align: center; border-radius: 8px;">
    
    <span id="closeModalBtn" style="position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; color: var(--text-muted); cursor: pointer; line-height: 1;">&times;</span>

    <h3 id="modalTitle">Modal Title</h3>
    <div id="modalBody" style="margin: 20px 0;"></div>
    <p id="errorMsg" style="color: red; font-weight: bold; margin-top: -10px; margin-bottom: 10px; display: none;"></p>
    <div id="modalActions">
      <button id="modalDoneBtn" class="run-button"><strong>DONE</strong></button>
    </div>
  </div>
</div>


<script>
const tabs = document.querySelectorAll('.tab');
const editors = document.querySelectorAll('textarea');
const iframe = document.getElementById('output');
const autoRunCheckbox = document.getElementById('autoRun');
const showConsoleCheckbox = document.getElementById('showConsole');
const themeToggle = document.getElementById('themeToggle');
const consoleContainer = document.querySelector('.console-container');
const consoleOutput = document.getElementById('consoleOutput');
const divider = document.querySelector('.divider');
const editorsPanel = document.querySelector('.editors');
const lineNumbers = document.getElementById('lineNumbers');
const editorContainer = document.querySelector('.editor-container');
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');
const applySettingsBtn = document.getElementById('applySettings');
const resetSettingsBtn = document.getElementById('resetSettings');

const editorBgColorInput = document.getElementById('editorBgColor');
const editorBgColorText = document.getElementById('editorBgColorText');
const editorTextColorInput = document.getElementById('editorTextColor');
const editorTextColorText = document.getElementById('editorTextColorText');
const editorTextSizeInput = document.getElementById('editorTextSize');
const textSizeValue = document.getElementById('textSizeValue');
const editorFontFamilySelect = document.getElementById('editorFontFamily');
const settingsPreview = document.getElementById('settingsPreview');
let hasUnsavedChanges = false; // Flag to track changes

// Default settings
const defaultSettings = {
  bgColor: '#1E1E1E',
  textColor: '#ffffff',
  textSize: '14',
  fontFamily: 'monospace'
};

// Load saved settings or use defaults
function loadSettings() {
  const savedSettings = localStorage.getItem('editorSettings');
  if (savedSettings) {
    const settings = JSON.parse(savedSettings);
    editorBgColorInput.value = settings.bgColor;
    editorBgColorText.value = settings.bgColor;
    editorTextColorInput.value = settings.textColor;
    editorTextColorText.value = settings.textColor;
    editorTextSizeInput.value = settings.textSize;
    textSizeValue.textContent = settings.textSize + 'px';
    editorFontFamilySelect.value = settings.fontFamily;
  } else {
    editorBgColorInput.value = defaultSettings.bgColor;
    editorBgColorText.value = defaultSettings.bgColor;
    editorTextColorInput.value = defaultSettings.textColor;
    editorTextColorText.value = defaultSettings.textColor;
    editorTextSizeInput.value = defaultSettings.textSize;
    textSizeValue.textContent = defaultSettings.textSize + 'px';
    editorFontFamilySelect.value = defaultSettings.fontFamily;
  }
  updatePreviewBox();
  applySettingsToEditors();
}

// Update preview box
function updatePreviewBox() {
  settingsPreview.style.backgroundColor = editorBgColorInput.value;
  settingsPreview.style.color = editorTextColorInput.value;
  settingsPreview.style.fontSize = editorTextSizeInput.value + 'px';
  settingsPreview.style.fontFamily = editorFontFamilySelect.value;
}

// Apply settings to all editors
function applySettingsToEditors() {
  editors.forEach(editor => {
    editor.style.backgroundColor = editorBgColorInput.value;
    editor.style.color = editorTextColorInput.value;
    editor.style.fontSize = editorTextSizeInput.value + 'px';
    editor.style.fontFamily = editorFontFamilySelect.value;
  });
  
  // Also update line numbers
  lineNumbers.style.fontSize = editorTextSizeInput.value + 'px';
}

// Event listeners for real-time preview
editorBgColorInput.addEventListener('input', (e) => {
  editorBgColorText.value = e.target.value;
  updatePreviewBox();
});

editorTextColorInput.addEventListener('input', (e) => {
  editorTextColorText.value = e.target.value;
  updatePreviewBox();
});

editorTextSizeInput.addEventListener('input', (e) => {
  textSizeValue.textContent = e.target.value + 'px';
  updatePreviewBox();
});

editorFontFamilySelect.addEventListener('change', updatePreviewBox);

// Open settings modal
settingsBtn.addEventListener('click', () => {
  loadSettings();
  settingsModal.style.display = 'flex';
});

// Close settings modal
closeSettingsBtn.addEventListener('click', () => {
  settingsModal.style.display = 'none';
});

// Close modal when clicking outside
settingsModal.addEventListener('click', (e) => {
  if (e.target === settingsModal) {
    settingsModal.style.display = 'none';
  }
});

// Apply settings
applySettingsBtn.addEventListener('click', () => {
  const settings = {
    bgColor: editorBgColorInput.value,
    textColor: editorTextColorInput.value,
    textSize: editorTextSizeInput.value,
    fontFamily: editorFontFamilySelect.value
  };
  
  localStorage.setItem('editorSettings', JSON.stringify(settings));
  applySettingsToEditors();
  alert('Settings applied successfully!');
  settingsModal.style.display = 'none';
});

// Reset settings to default
resetSettingsBtn.addEventListener('click', () => {
  if (confirm('Are you sure you want to reset all settings to default?')) {
    localStorage.removeItem('editorSettings');
    editorBgColorInput.value = defaultSettings.bgColor;
    editorBgColorText.value = defaultSettings.bgColor;
    editorTextColorInput.value = defaultSettings.textColor;
    editorTextColorText.value = defaultSettings.textColor;
    editorTextSizeInput.value = defaultSettings.textSize;
    textSizeValue.textContent = defaultSettings.textSize + 'px';
    editorFontFamilySelect.value = defaultSettings.fontFamily;
    updatePreviewBox();
    applySettingsToEditors();
    alert('Settings reset to default!');
  }
});

// Load settings on page load
window.addEventListener('load', () => {
  loadSettings();
});

// Theme toggle functionality
themeToggle.addEventListener('change', () => {
  document.body.classList.toggle('light', themeToggle.checked);
  localStorage.setItem('theme', themeToggle.checked ? 'light' : 'dark');
});

// Load saved theme preference
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'light') {
  themeToggle.checked = true;
  document.body.classList.add('light');
}

// Tab switching
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    editors.forEach(editor => editor.classList.remove('active'));
    const activeEditor = document.getElementById(tab.dataset.tab + 'Code');
    activeEditor.classList.add('active');
    updateLineNumbers(activeEditor);
    syncScroll(activeEditor);
  });
});

// Toggle console
showConsoleCheckbox.addEventListener('change', () => {
  consoleContainer.classList.toggle('show', showConsoleCheckbox.checked);
});

// Update preview with console capture
function updatePreview() {
  const html = document.getElementById('htmlCode').value;
  const css = `<style>${document.getElementById('cssCode').value}</style>`;
  const js = document.getElementById('jsCode').value;
  
  consoleOutput.innerHTML = ''; // Clear console on each run
  
  let jsWithConsole = '';
if (js.trim()) {
  jsWithConsole = `<script>
    const parentConsole = parent.document.getElementById('consoleOutput');
    function appendMessage(type, prefix, args) {
      const line = document.createElement('div');
      line.className = 'console-' + type;
      line.textContent = prefix + args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      parentConsole.appendChild(line);

      // ✅ Auto-scroll to bottom
      parentConsole.scrollTop = parentConsole.scrollHeight;
    }
    console.log = (...args) => { appendMessage('log', '> ', args); };
    console.warn = (...args) => { appendMessage('warn', '⚠️ WARNING: ', args); };
    console.error = (...args) => { appendMessage('error', '❌ ERROR: ', args); };
    window.onerror = (msg, src, line) => { appendMessage('error', '❌ Uncaught: ', [msg + ' (line ' + line + ')']); return false; };
    window.addEventListener('unhandledrejection', e => appendMessage('error', '❌ Promise: ', [e.reason]));
    try { ${js} } catch(e) { appendMessage('error', '❌ Script Error: ', [e.message]); }
  <\/script>`;
}


  
  iframe.srcdoc = html + css + jsWithConsole;
}

// Line numbers function
function updateLineNumbers(textarea = document.querySelector('textarea.active')) {
  if (!textarea) return;
  const lines = textarea.value.split('\n').length;
  lineNumbers.textContent = Array.from({ length: lines }, (_, i) => i + 1).join('\n');
}

// Sync scrolling between textarea and line numbers
function syncScroll(textarea) {
  if (!textarea) return;
  textarea.addEventListener('scroll', () => { lineNumbers.scrollTop = textarea.scrollTop; });
}

// Initialize editors
editors.forEach(editor => {
  updateLineNumbers(editor);
  syncScroll(editor);
  editor.addEventListener('input', () => {
    hasUnsavedChanges = true; // Set flag on input
    updateLineNumbers(editor);
    if (autoRunCheckbox.checked) updatePreview();
  });
  editor.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = this.selectionStart, end = this.selectionEnd;
      this.value = this.value.substring(0, start) + "  " + this.value.substring(end);
      this.selectionStart = this.selectionEnd = start + 2;
      if (autoRunCheckbox.checked) updatePreview();
    }
  });
});

// Drag & Drop support
['dragover', 'dragleave', 'drop'].forEach(eventName => {
    editorContainer.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
        if (eventName === 'dragover') editorContainer.classList.add('dragover');
        if (eventName === 'dragleave' || eventName === 'drop') editorContainer.classList.remove('dragover');
    });
});
editorContainer.addEventListener('drop', e => {
    for (const file of e.dataTransfer.files) {
        const reader = new FileReader();
        reader.onload = ev => {
            const content = ev.target.result;
            const ext = file.name.split('.').pop();
            const targetId = {html: 'htmlCode', css: 'cssCode', js: 'jsCode'}[ext];
            if (targetId) {
                const editor = document.getElementById(targetId);
                editor.value = content;
                hasUnsavedChanges = true; // Set flag on drop
                updateLineNumbers(editor);
                if (autoRunCheckbox.checked) updatePreview();
            }
        };
        reader.readAsText(file);
    }
});

// Initialize preview
updatePreview();

// Resizable panels
let isResizing = false;
divider.addEventListener('mousedown', () => { isResizing = true; });
document.addEventListener('mousemove', e => {
  if (!isResizing) return;
  const isMobile = window.innerWidth <= 768;
  document.body.style.cursor = isMobile ? 'row-resize' : 'col-resize';
  const newSize = isMobile ? e.clientY : e.clientX;
  const maxSize = isMobile ? window.innerHeight : window.innerWidth;
  if (newSize > 100 && newSize < maxSize - 100) {
    editorsPanel.style[isMobile ? 'height' : 'width'] = newSize + 'px';
  }
});
document.addEventListener('mouseup', () => { 
  isResizing = false; 
  document.body.style.cursor = 'default';
});

// ZIP functionality
function exportAsZip() {
  hasUnsavedChanges = false; // Assume exporting is a form of saving
  const zip = new JSZip();
  zip.file("index.html", document.getElementById('htmlCode').value);
  zip.file("style.css", document.getElementById('cssCode').value);
  zip.file("script.js", document.getElementById('jsCode').value);
  zip.generateAsync({ type: "blob" }).then(content => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(content);
    a.download = "code.zip";
    a.click();
  });
}

function importZip() { document.getElementById('zipFileInput').click(); }

function handleZipImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  JSZip.loadAsync(file).then(zip => {
    ['html', 'css', 'js'].forEach(lang => document.getElementById(lang + 'Code').value = '');
    const promises = [];
    zip.forEach((path, entry) => {
        const ext = path.split('.').pop();
        const targetId = {html: 'htmlCode', css: 'cssCode', js: 'jsCode'}[ext];
        if (targetId && !entry.dir) {
            promises.push(entry.async("string").then(content => {
                document.getElementById(targetId).value = content;
            }));
        }
    });
    Promise.all(promises).then(() => {
        hasUnsavedChanges = true; // Set flag after importing
        updateLineNumbers();
        if (autoRunCheckbox.checked) updatePreview();
        alert('ZIP project imported successfully!');
    });
  }).catch(err => alert('Error reading ZIP file.'));
  event.target.value = '';
}

// Fullscreen for the whole page
const fullscreenBtn = document.getElementById('fullscreenBtn');
fullscreenBtn.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    fullscreenBtn.innerHTML = "<strong>⤢ EXIT FULLSCREEN</strong>";
  } else {
    document.exitFullscreen();
    fullscreenBtn.innerHTML = "<strong>⛶ FULLSCREEN MODE</strong>";
  }
});

updateLineNumbers();


// ===============================================
// ========= CONFIRM ON CLOSE IF UNSAVED =========
// ===============================================
window.addEventListener('beforeunload', function (e) {
    if (hasUnsavedChanges) {
        // Cancel the event
        e.preventDefault();
        // Chrome requires returnValue to be set
        e.returnValue = '';
        // Most browsers will show a generic message, but returning one is good practice
        return 'Are you sure you want to leave? Your changes may not be saved.';
    }
});


// =======================================================
// ========= COLLABORATION & PREVIEW FULLSCREEN CODE =====
// =======================================================

// --- Element Selectors ---
const collabBtn = document.getElementById('collabBtn');
const collabModal = document.getElementById('collabModal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalDoneBtn = document.getElementById('modalDoneBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
const typingIndicatorEl = document.getElementById('typingIndicator');
const previewFullscreenBtn = document.getElementById('previewFullscreenBtn');
const previewIframe = document.getElementById('output');
const errorMsgEl = document.getElementById('errorMsg');

// --- Global Variables ---
let sessionData = {};
let typingTimer;
let myInfo = {}; 

// --- Event Listeners ---
closeModalBtn.addEventListener('click', closeModal);
collabBtn.addEventListener('click', startCollaboration);
window.addEventListener('load', checkForSession);
window.addEventListener('storage', handleStorageChange);
previewFullscreenBtn.addEventListener('click', togglePreviewFullscreen);
document.addEventListener('fullscreenchange', updateFullscreenButtonState);


// --- Typing Indicator Functions ---
function announceTyping(activeEditorId) {
    if (!myInfo.name) return;
    clearTimeout(typingTimer);
    const sessionId = localStorage.getItem('activeSessionId');
    if (!sessionId) return;
    
    let session;
    try { session = JSON.parse(localStorage.getItem(sessionId)); if (!session) return; } catch (e) { return; }

    session.typingIndicator = { name: myInfo.name, theme: myInfo.theme, editor: activeEditorId };
    localStorage.setItem(sessionId, JSON.stringify(session));

    typingTimer = setTimeout(() => {
        try {
            session = JSON.parse(localStorage.getItem(sessionId));
            if (!session) return;
            session.typingIndicator = null;
            localStorage.setItem(sessionId, JSON.stringify(session));
        } catch(e) {}
    }, 1500);
}

function updateTypingIndicatorUI(indicator) {
    editors.forEach(editor => { editor.style.boxShadow = 'none'; });
    if (indicator && indicator.name !== myInfo.name) {
        const activeEditor = document.getElementById(indicator.editor);
        if (activeEditor) {
            activeEditor.style.boxShadow = `0 0 0 3px ${indicator.theme} inset`;
            typingIndicatorEl.textContent = `${indicator.name} is typing...`;
            typingIndicatorEl.style.backgroundColor = indicator.theme;
            typingIndicatorEl.style.display = 'block';
        }
    } else {
        typingIndicatorEl.style.display = 'none';
    }
}


// --- Collaboration Host POV ---
function startCollaboration() {
  const sessionId = localStorage.getItem('activeSessionId');
  const sessionStr = sessionId ? localStorage.getItem(sessionId) : null;

  // If already in a session, show the session info
  if (sessionStr && myInfo.name) {
      const currentSession = JSON.parse(sessionStr);
      const collabLink = window.location.href.split('#')[0] + '#' + sessionId;

      modalTitle.innerHTML = '<strong>SESSION DETAILS</strong>';

      let participantsHTML = '<h4>Participants:</h4><ul style="list-style: none; padding: 0; text-align: left;">';
      currentSession.participants.forEach(p => {
          participantsHTML += `<li style="padding: 5px;"><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${p.theme}; margin-right: 8px;"></span>${p.name}</li>`;
      });
      participantsHTML += '</ul>';

      modalBody.innerHTML = `
          <p><strong>SHARE THIS LINK TO INVITE OTHERS:</strong></p>
          <input type="text" readonly id="collabLinkInput" value="${collabLink}" style="width: 90%; padding: 8px; text-align: center;">
          <hr style="border-color: var(--border-color); margin: 15px 0;">
          ${participantsHTML}
      `;
      
      document.getElementById('modalActions').innerHTML = `
          <button class="run-button" onclick="copyLink()"><strong>COPY LINK</strong></button>
          <button class="run-button" onclick="closeModal()"><strong>CLOSE</strong></button>
      `;
      collabModal.style.display = 'flex';
      return;
  }

  // Otherwise, start a new session
  modalTitle.innerHTML = '<strong>START COLLABORATION</strong>';
  modalBody.innerHTML = '<p><strong>PLEASE ENTER YOUR NAME TO START:</strong></p><input type="text" id="userNameInput" placeholder="Your Name" style="width: 80%; padding: 8px;">';
  collabModal.style.display = 'flex';
  errorMsgEl.style.display = 'none';

  modalDoneBtn.onclick = () => {
    const userName = document.getElementById('userNameInput').value;
    if (!userName.trim()) return alert('Please enter a name.');
    sessionData.host = userName;
    promptForTheme();
  };
}

function promptForTheme() {
  modalTitle.innerHTML = '<strong>PICK A THEME COLOR</strong>';
  modalBody.innerHTML = `<p><strong>THIS COLOR WILL REPRESENT YOU.</strong></p><input type="color" id="userThemeInput" value="#4CAF50">`;
  errorMsgEl.style.display = 'none';

  modalDoneBtn.onclick = () => {
    sessionData.theme = document.getElementById('userThemeInput').value;
    generateSessionLink();
  };
}

function generateSessionLink() {
  const sessionId = 'session-' + Date.now();
  const collabLink = window.location.href.split('#')[0] + '#' + sessionId;

  const initialState = {
    id: sessionId,
    html: document.getElementById('htmlCode').value,
    css: document.getElementById('cssCode').value,
    js: document.getElementById('jsCode').value,
    participants: [{ name: sessionData.host, theme: sessionData.theme }]
  };
  localStorage.setItem(sessionId, JSON.stringify(initialState));
  localStorage.setItem('activeSessionId', sessionId);

  myInfo = { name: sessionData.host, theme: sessionData.theme };

  modalTitle.innerHTML = '<strong>SHARE THIS LINK WITH FRIENDS!</strong>';
  modalBody.innerHTML = `<p><strong>YOUR SESSION IS READY. COPY THE LINK BELOW:</strong></p><input type="text" readonly id="collabLinkInput" value="${collabLink}" style="width: 90%; padding: 8px; text-align: center;">`;
  document.getElementById('modalActions').innerHTML = `<button class="run-button" onclick="copyLink()"><strong>COPY LINK</strong></button><button class="run-button" onclick="closeModal()"><strong>CLOSE</strong></button>`;
  
  startSyncing();
}

function copyLink() {
  document.getElementById('collabLinkInput').select();
  document.execCommand('copy');
  alert('Link copied to clipboard!');
}

function closeModal() {
  collabModal.style.display = 'none';
  // Restore default "Done" button
  document.getElementById('modalActions').innerHTML = `<button id="modalDoneBtn" class="run-button"><strong>DONE</strong></button>`;
}

// --- Collaboration Friend POV ---
function checkForSession() {
  const sessionId = window.location.hash.substring(1);
  if (sessionId.startsWith('session-')) {
    localStorage.setItem('activeSessionId', sessionId);
    modalTitle.innerHTML = '<strong>JOIN COLLABORATION</strong>';
    modalBody.innerHTML = '<p><strong>PLEASE ENTER YOUR NAME TO JOIN:</strong></p><input type="text" id="userNameInput" placeholder="Your Name" style="width: 80%; padding: 8px;">';
    collabModal.style.display = 'flex';
    errorMsgEl.style.display = 'none';

    modalDoneBtn.onclick = () => {
      const userNameInput = document.getElementById('userNameInput');
      const userName = userNameInput.value;

      if (!userName.trim()) {
        return alert('Please enter a name.');
      }
      
      const sessionStr = localStorage.getItem(sessionId);
      if (sessionStr) {
        const currentSession = JSON.parse(sessionStr);
        const isNameTaken = currentSession.participants.some(p => p.name.toLowerCase() === userName.toLowerCase());

        if (isNameTaken) {
          errorMsgEl.textContent = 'That name is already taken.';
          errorMsgEl.style.display = 'block';
          userNameInput.focus();
          return;
        }
      }
      
      errorMsgEl.style.display = 'none';
      promptForThemeAndJoin(userName);
    };
  }
}

function promptForThemeAndJoin(userName) {
    modalTitle.innerHTML = '<strong>PICK YOUR THEME COLOR</strong>';
    modalBody.innerHTML = `<input type="color" id="userThemeInput" value="#2196F3">`;
    errorMsgEl.style.display = 'none';

    modalDoneBtn.onclick = () => {
        const userTheme = document.getElementById('userThemeInput').value;
        const sessionId = localStorage.getItem('activeSessionId');
        const sessionStr = localStorage.getItem(sessionId);

        if(sessionStr) {
            myInfo = { name: userName, theme: userTheme };
            const currentSession = JSON.parse(sessionStr);
            currentSession.participants.push({ name: userName, theme: userTheme });
            localStorage.setItem(sessionId, JSON.stringify(currentSession));

            document.getElementById('htmlCode').value = currentSession.html;
            document.getElementById('cssCode').value = currentSession.css;
            document.getElementById('jsCode').value = currentSession.js;
            updatePreview();
            
            alert(`Welcome, ${userName}! You've joined the session.`);
            startSyncing();
        } else {
             alert("Error: Collaboration session not found.");
        }
        closeModal();
    };
}

// --- Syncing Logic ---
function handleCodeChange(event) {
    const sessionId = localStorage.getItem('activeSessionId');
    if (!sessionId) return;
    const currentSessionStr = localStorage.getItem(sessionId);
    if (!currentSessionStr) return;
    let session = JSON.parse(currentSessionStr);

    const key = event.target.id.replace('Code', '');
    session[key] = event.target.value;
    
    localStorage.setItem(sessionId, JSON.stringify(session));
}

function startSyncing() {
    editors.forEach(editor => {
        editor.addEventListener('input', handleCodeChange);
        editor.addEventListener('input', (event) => announceTyping(event.target.id));
    });
}

function handleStorageChange(event) {
    const sessionId = localStorage.getItem('activeSessionId');
    if (event.key === sessionId && event.newValue) {
        const newValue = JSON.parse(event.newValue);
        if (document.getElementById('htmlCode').value !== newValue.html) {
            document.getElementById('htmlCode').value = newValue.html;
        }
        if (document.getElementById('cssCode').value !== newValue.css) {
            document.getElementById('cssCode').value = newValue.css;
        }
        if (document.getElementById('jsCode').value !== newValue.js) {
            document.getElementById('jsCode').value = newValue.js;
        }
        
        updateTypingIndicatorUI(newValue.typingIndicator);
        updateLineNumbers();
        if (autoRunCheckbox.checked) updatePreview();
    }
}

// --- Preview Fullscreen Logic ---
function togglePreviewFullscreen() {
  if (!document.fullscreenElement) {
    if (previewIframe.requestFullscreen) {
      previewIframe.requestFullscreen();
    } else if (previewIframe.webkitRequestFullscreen) { /* Safari */
      previewIframe.webkitRequestFullscreen();
    } else if (previewIframe.msRequestFullscreen) { /* IE11 */
      previewIframe.msRequestFullscreen();
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    }
  }
}

function updateFullscreenButtonState() {
    if (document.fullscreenElement === previewIframe) {
        previewFullscreenBtn.innerHTML = `
            <svg class="btn-icon" viewBox="0 0 24 24">
                <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
            </svg>
            <strong>EXIT FULLSCREEN</strong>
        `;
        previewFullscreenBtn.title = 'Exit Fullscreen';
    } else {
        previewFullscreenBtn.innerHTML = `
            <svg class="btn-icon" viewBox="0 0 24 24">
                <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
            <strong>FULLSCREEN PREVIEW</strong>
        `;
        previewFullscreenBtn.title = 'Enter Fullscreen';
    }
}
</script>

</body>
</html>