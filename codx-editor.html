<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link rel="icon" type="image/png" href="cx.png">
<title>CodX Editor</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
:root {
    /* Dark mode colors (default) */
    --bg-primary: #000000;
    --bg-secondary: #1E1E1E;
    --bg-tertiary: #2C2C2C;
    --text-primary: #ffffff;
    --text-secondary: #aaaaaa;
    --text-muted: #888888;
    --accent-color: #4CAF50;
    --accent-hover: #45a049;
    --border-color: #333333;
    --divider-color: #333333;
    --console-bg: #000000;
    --console-text: #00ff00;
    --preview-bg: #ffffff;
    --preview-text: #000000;
    --shadow-subtle: rgba(0, 0, 0, 0.3);
    --shadow-strong: rgba(0, 0, 0, 0.6);
    --gradient-primary: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  }

  body.light {
    /* Light mode colors */
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e0e0e0;
    --text-primary: #000000;
    --text-secondary: #666666;
    --text-muted: #999999;
    --accent-color: #2196F3;
    --accent-hover: #1976D2;
    --border-color: #cccccc;
    --divider-color: #cccccc;
    --console-bg: #f8f8f8;
    --console-text: #333333;
    --preview-bg: #ffffff;
    --preview-text: #000000;
    --shadow-subtle: rgba(0, 0, 0, 0.1);
    --shadow-strong: rgba(0, 0, 0, 0.2);
    --gradient-primary: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
    color: var(--text-primary);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  header {
    background: var(--gradient-primary);
    color: var(--text-primary);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    font-size: 1.1em;
    gap: 12px;
    box-shadow: 0 2px 10px var(--shadow-subtle);
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    flex-wrap: wrap;
    position: relative;
    z-index: 100;
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 26px;
  }

  .switch input { 
    opacity: 0; 
    width: 0; 
    height: 0; 
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; 
    left: 0; 
    right: 0; 
    bottom: 0;
    background: var(--text-muted);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 26px;
    box-shadow: inset 0 2px 4px var(--shadow-subtle);
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 20px; 
    width: 20px;
    left: 3px; 
    bottom: 3px;
    background: white;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 50%;
    box-shadow: 0 2px 6px var(--shadow-subtle);
  }

  input:checked + .slider { 
    background: var(--accent-color);
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
  }

  input:checked + .slider:before { 
    transform: translateX(26px); 
    box-shadow: 0 2px 8px var(--shadow-strong);
  }

  .slider:hover {
    box-shadow: 0 0 15px var(--shadow-subtle);
  }

  .theme-toggle {
    margin-left: auto;
    margin-right: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2em;
  }

  .editor-container {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
  }

  .editor-container.dragover {
    border: 3px dashed var(--accent-color);
    background: rgba(76, 175, 80, 0.05);
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }

  .editors {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-secondary);
    min-width: 200px;
    max-width: 80%;
    width: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 0 8px 0 0;
    box-shadow: 2px 0 10px var(--shadow-subtle);
  }

  .tabs {
    display: flex;
    background: var(--bg-tertiary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-bottom: 1px solid var(--border-color);
    position: relative;
  }

  .tab {
    flex: 1;
    padding: 14px 16px;
    text-align: center;
    cursor: pointer;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    font-weight: 600;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .tab::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
  }

  .tab:hover::before {
    left: 100%;
  }

  .tab:hover {
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-2px);
  }

  .tab.active {
    color: var(--text-primary);
    border-bottom: 3px solid var(--accent-color);
    background: var(--bg-secondary);
    box-shadow: 0 -2px 8px var(--shadow-subtle);
  }

  .code-container {
    position: relative;
    display: flex;
    flex: 1;
    background: var(--bg-secondary);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .line-numbers {
    width: 55px;
    padding: 12px 8px 12px 0;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    text-align: right;
    user-select: none;
    font-family: 'Fira Code', 'Monaco', 'Cascadia Code', monospace;
    font-size: 13px;
    line-height: 1.5;
    overflow: hidden;
    white-space: pre;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-right: 2px solid var(--border-color);
    box-shadow: 2px 0 5px var(--shadow-subtle);
  }

  .editor-wrapper {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  textarea {
    width: 100%;
    height: 100%;
    border: none;
    padding: 12px 16px;
    font-family: 'Fira Code', 'Monaco', 'Cascadia Code', monospace;
    font-size: 14px;
    line-height: 1.5;
    outline: none;
    resize: none;
    background: var(--bg-secondary);
    color: var(--text-primary);
    display: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: absolute;
    top: 0;
    left: 0;
    box-sizing: border-box;
    font-weight: 400;
  }

  textarea.active { 
    display: block; 
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  textarea:focus {
    box-shadow: inset 0 0 0 2px var(--accent-color);
  }

  .run-button {
    background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
    color: white;
    border: none;
    padding: 10px 18px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    margin: 4px;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
  }

  .run-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  .run-button:hover::before {
    left: 100%;
  }

  .run-button:hover { 
    background: linear-gradient(135deg, var(--accent-hover) 0%, var(--accent-color) 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  }

  .run-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .btn-icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
    transition: transform 0.3s ease;
  }

  .run-button:hover .btn-icon {
    transform: scale(1.1);
  }

  .divider {
    width: 12px;
    cursor: col-resize;
    background: var(--gradient-primary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    border-left: 1px solid var(--border-color);
    border-right: 1px solid var(--border-color);
  }

  .divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 4px;
    height: 40px;
    background: var(--text-muted);
    border-radius: 2px;
    transition: all 0.3s ease;
  }

  .divider:hover {
    background: var(--accent-color);
    width: 16px;
  }

  .divider:hover::before {
    background: white;
    height: 50px;
  }

  .preview {
    flex: 1;
    background: var(--preview-bg);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px 0 0 0;
    box-shadow: -2px 0 10px var(--shadow-subtle);
  }

  iframe {
    width: 100%;
    flex: 1;
    border: none;
    background: var(--preview-bg);
    color: var(--preview-text);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px 0 0 0;
  }

  .console-container {
    flex: none;
    height: 150px;
    border-top: 2px solid var(--border-color);
    display: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--console-bg);
    box-shadow: 0 -4px 10px var(--shadow-subtle);
  }

  .console-container.show {
    display: block;
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from { 
      opacity: 0; 
      transform: translateY(20px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }

  .console-output {
    width: 100%;
    height: 100%;
    background: var(--console-bg);
    color: var(--console-text);
    font-family: 'Fira Code', 'Monaco', 'Cascadia Code', monospace;
    font-size: 13px;
    padding: 12px;
    overflow-y: auto;
    white-space: pre-wrap;
    line-height: 1.4;
  }

  /* Enhanced scrollbar styling */
  .console-output::-webkit-scrollbar {
    width: 10px;
  }

  .console-output::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: 5px;
  }

  .console-output::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, var(--text-muted) 0%, var(--accent-color) 100%);
    border-radius: 5px;
    transition: all 0.3s ease;
  }

  .console-output::-webkit-scrollbar-thumb:hover {
    background: var(--accent-color);
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
  }

  /* Button container styling */
  .code-container + div {
    display: flex;
    gap: 6px;
    padding: 12px;
    justify-content: center;
    background: var(--gradient-primary);
    border-top: 1px solid var(--border-color);
    box-shadow: 0 -2px 8px var(--shadow-subtle);
  }

  @media (max-width: 768px) {
    header {
      padding: 10px 16px;
      font-size: 1em;
    }
    
    .editor-container { 
      flex-direction: column; 
    }
    
    .editors { 
      width: 100% !important; 
      max-width: 100%; 
      height: 50vh; 
      border-radius: 0;
    }
    
    .divider { 
      width: 100%; 
      height: 8px; 
      cursor: row-resize; 
    }
    
    .divider::before {
      width: 40px;
      height: 4px;
    }
    
    .preview { 
      height: 50vh; 
      border-radius: 0;
    }
    
    .code-container { 
      flex-direction: row; 
    }
    
    .tabs { 
      flex-wrap: wrap; 
    }
    
    .tab {
      flex: 1;
      min-width: 80px;
      padding: 12px 10px;
      font-size: 0.8em;
    }
    
    .theme-toggle { 
      margin-left: 10px; 
      margin-right: 0; 
    }
    
    .run-button {
      padding: 8px 12px;
      font-size: 12px;
      margin: 2px;
    }
  }

  .header-btn {
    background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
    margin-left: auto;
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 11px;
  }

  .header-btn:hover {
    background: var(--accent-color);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px var(--shadow-subtle);
  }

  /* Typing indicator improvements */
  #typingIndicator {
    border-radius: 12px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    box-shadow: 0 2px 8px var(--shadow-strong);
    animation: fadeIn 0.3s ease-in-out;
  }

  /* Modal improvements */
  #collabModal > div {
    border-radius: 12px;
    box-shadow: 0 20px 60px var(--shadow-strong);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
  }

  /* Input field improvements */
  input[type="text"], input[type="color"] {
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 12px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-family: inherit;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  input[type="text"]:focus, input[type="color"]:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
  }

  /* Smooth transitions for all elements */
  * {
    transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
</style>
</head>
<body>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/theme/material.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/theme/eclipse.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/edit/closebrackets.min.js"></script>

<header>
  <div style="display: flex; align-items: center; gap: 8px;">
    <span>Auto-Run</span>
    <label class="switch">
      <input type="checkbox" id="autoRun" checked>
      <span class="slider"></span>
    </label>

    <span>Console</span>
    <label class="switch">
      <input type="checkbox" id="showConsole">
      <span class="slider"></span>
    </label>
  </div>
  
  <button id="collabBtn" class="run-button" style="margin-left: 20px;">
    <svg class="btn-icon" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
    Collab with Friends
  </button>
  
  <button id="previewFullscreenBtn" class="run-button" title="Toggle Preview Fullscreen">
    <svg class="btn-icon" viewBox="0 0 24 24">
        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
    </svg>
    Fullscreen Preview
  </button>

  <div class="theme-toggle">
    <span>🌙</span>
    <label class="switch">
      <input type="checkbox" id="themeToggle">
      <span class="slider"></span>
    </label>
    <span>☀️</span>
  </div>

  <div>
    <b>CodX Editor</b>
  </div>
</header>

<div class="editor-container">
  <div class="editors">
    <div class="tabs">
      <div class="tab active" data-tab="html">HTML</div>
      <div class="tab" data-tab="css">CSS</div>
      <div class="tab" data-tab="js">JS</div>
      <button id="fullscreenBtn" class="header-btn">⛶ Fullscreen Mode</button>
    </div>

    <div class="code-container">
      <div class="line-numbers" id="lineNumbers">1</div>
      <div class="editor-wrapper">
        <textarea id="htmlCode" class="active">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;CodX Editor&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Welcome to CodX Editor&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</textarea>
        <textarea id="cssCode">h1 {color: rgb(2, 255, 116);
    text-align: center;
    font-family: Arial, sans-serif;}</textarea>
        <textarea id="jsCode">console.log('Hello World from CodX!');</textarea>
      </div>
      <div id="typingIndicator" style="display: none; position: absolute; top: 5px; right: 15px; padding: 3px 8px; border-radius: 4px; font-size: 12px; color: white; transition: opacity 0.3s ease; z-index:10;"></div>
    </div>

    <div style="display: flex; gap: 5px; padding: 8px; justify-content: center; background: var(--bg-tertiary); border-top: 1px solid var(--border-color);">
      <button class="run-button" onclick="updatePreview()">
        <svg class="btn-icon" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
        Run
      </button>
      <button class="run-button" onclick="exportAsZip()">
        <i class="fa-solid fa-file-zipper"></i>
        Export ZIP File
      </button>
      <button class="run-button" onclick="importZip()">
        <i class="fa-solid fa-file-import"></i>
        Import ZIP File
      </button>
      <input type="file" id="zipFileInput" accept=".zip" style="display: none;" onchange="handleZipImport(event)">
    </div>
  </div>

  <div class="divider"></div>

  <div class="preview">
    <iframe id="output"></iframe>
    <div class="console-container" id="consoleContainer">
  <div id="consoleOutput" class="console-output"></div>
</div>

  </div>
</div>

<div id="collabModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
  <div style="position: relative; background-color: var(--bg-secondary); margin: 15% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 400px; text-align: center; border-radius: 8px;">
    
    <span id="closeModalBtn" style="position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; color: var(--text-muted); cursor: pointer; line-height: 1;">&times;</span>

    <h3 id="modalTitle">Modal Title</h3>
    <div id="modalBody" style="margin: 20px 0;"></div>
    <div id="modalActions">
      <button id="modalDoneBtn" class="run-button">Done</button>
    </div>
  </div>
</div>


<script>
const tabs = document.querySelectorAll('.tab');
const editors = document.querySelectorAll('textarea');
const iframe = document.getElementById('output');
const autoRunCheckbox = document.getElementById('autoRun');
const showConsoleCheckbox = document.getElementById('showConsole');
const themeToggle = document.getElementById('themeToggle');
const consoleContainer = document.querySelector('.console-container');
const consoleOutput = document.getElementById('consoleOutput');
const divider = document.querySelector('.divider');
const editorsPanel = document.querySelector('.editors');
const lineNumbers = document.getElementById('lineNumbers');
const editorContainer = document.querySelector('.editor-container');
let hasUnsavedChanges = false; // Flag to track changes

// Theme toggle functionality
themeToggle.addEventListener('change', () => {
  document.body.classList.toggle('light', themeToggle.checked);
  localStorage.setItem('theme', themeToggle.checked ? 'light' : 'dark');
});

// Load saved theme preference
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'light') {
  themeToggle.checked = true;
  document.body.classList.add('light');
}

// Tab switching
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    editors.forEach(editor => editor.classList.remove('active'));
    const activeEditor = document.getElementById(tab.dataset.tab + 'Code');
    activeEditor.classList.add('active');
    updateLineNumbers(activeEditor);
    syncScroll(activeEditor);
  });
});

// Toggle console
showConsoleCheckbox.addEventListener('change', () => {
  consoleContainer.classList.toggle('show', showConsoleCheckbox.checked);
});

// Update preview with console capture
function updatePreview() {
  const html = document.getElementById('htmlCode').value;
  const css = `<style>${document.getElementById('cssCode').value}</style>`;
  const js = document.getElementById('jsCode').value;
  
  consoleOutput.innerHTML = ''; // Clear console on each run
  
  let jsWithConsole = '';
if (js.trim()) {
  jsWithConsole = `<script>
    const parentConsole = parent.document.getElementById('consoleOutput');
    function appendMessage(type, prefix, args) {
      const line = document.createElement('div');
      line.className = 'console-' + type;
      line.textContent = prefix + args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      parentConsole.appendChild(line);

      // ✅ Auto-scroll to bottom
      parentConsole.scrollTop = parentConsole.scrollHeight;
    }
    console.log = (...args) => { appendMessage('log', '> ', args); };
    console.warn = (...args) => { appendMessage('warn', '⚠️ WARNING: ', args); };
    console.error = (...args) => { appendMessage('error', '❌ ERROR: ', args); };
    window.onerror = (msg, src, line) => { appendMessage('error', '❌ Uncaught: ', [msg + ' (line ' + line + ')']); return false; };
    window.addEventListener('unhandledrejection', e => appendMessage('error', '❌ Promise: ', [e.reason]));
    try { ${js} } catch(e) { appendMessage('error', '❌ Script Error: ', [e.message]); }
  <\/script>`;
}


  
  iframe.srcdoc = html + css + jsWithConsole;
}

// Line numbers function
function updateLineNumbers(textarea = document.querySelector('textarea.active')) {
  if (!textarea) return;
  const lines = textarea.value.split('\n').length;
  lineNumbers.textContent = Array.from({ length: lines }, (_, i) => i + 1).join('\n');
}

// Sync scrolling between textarea and line numbers
function syncScroll(textarea) {
  if (!textarea) return;
  textarea.addEventListener('scroll', () => { lineNumbers.scrollTop = textarea.scrollTop; });
}

// Initialize editors
editors.forEach(editor => {
  updateLineNumbers(editor);
  syncScroll(editor);
  editor.addEventListener('input', () => {
    hasUnsavedChanges = true; // Set flag on input
    updateLineNumbers(editor);
    if (autoRunCheckbox.checked) updatePreview();
  });
  editor.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = this.selectionStart, end = this.selectionEnd;
      this.value = this.value.substring(0, start) + "  " + this.value.substring(end);
      this.selectionStart = this.selectionEnd = start + 2;
      if (autoRunCheckbox.checked) updatePreview();
    }
  });
});

// Drag & Drop support
['dragover', 'dragleave', 'drop'].forEach(eventName => {
    editorContainer.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
        if (eventName === 'dragover') editorContainer.classList.add('dragover');
        if (eventName === 'dragleave' || eventName === 'drop') editorContainer.classList.remove('dragover');
    });
});
editorContainer.addEventListener('drop', e => {
    for (const file of e.dataTransfer.files) {
        const reader = new FileReader();
        reader.onload = ev => {
            const content = ev.target.result;
            const ext = file.name.split('.').pop();
            const targetId = {html: 'htmlCode', css: 'cssCode', js: 'jsCode'}[ext];
            if (targetId) {
                const editor = document.getElementById(targetId);
                editor.value = content;
                hasUnsavedChanges = true; // Set flag on drop
                updateLineNumbers(editor);
                if (autoRunCheckbox.checked) updatePreview();
            }
        };
        reader.readAsText(file);
    }
});

// Initialize preview
updatePreview();

// Resizable panels
let isResizing = false;
divider.addEventListener('mousedown', () => { isResizing = true; });
document.addEventListener('mousemove', e => {
  if (!isResizing) return;
  const isMobile = window.innerWidth <= 768;
  document.body.style.cursor = isMobile ? 'row-resize' : 'col-resize';
  const newSize = isMobile ? e.clientY : e.clientX;
  const maxSize = isMobile ? window.innerHeight : window.innerWidth;
  if (newSize > 100 && newSize < maxSize - 100) {
    editorsPanel.style[isMobile ? 'height' : 'width'] = newSize + 'px';
  }
});
document.addEventListener('mouseup', () => { 
  isResizing = false; 
  document.body.style.cursor = 'default';
});

// ZIP functionality
function exportAsZip() {
  hasUnsavedChanges = false; // Assume exporting is a form of saving
  const zip = new JSZip();
  zip.file("index.html", document.getElementById('htmlCode').value);
  zip.file("style.css", document.getElementById('cssCode').value);
  zip.file("script.js", document.getElementById('jsCode').value);
  zip.generateAsync({ type: "blob" }).then(content => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(content);
    a.download = "CodX-Project.zip";
    a.click();
  });
}

function importZip() { document.getElementById('zipFileInput').click(); }

function handleZipImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  JSZip.loadAsync(file).then(zip => {
    ['html', 'css', 'js'].forEach(lang => document.getElementById(lang + 'Code').value = '');
    const promises = [];
    zip.forEach((path, entry) => {
        const ext = path.split('.').pop();
        const targetId = {html: 'htmlCode', css: 'cssCode', js: 'jsCode'}[ext];
        if (targetId && !entry.dir) {
            promises.push(entry.async("string").then(content => {
                document.getElementById(targetId).value = content;
            }));
        }
    });
    Promise.all(promises).then(() => {
        hasUnsavedChanges = true; // Set flag after importing
        updateLineNumbers();
        if (autoRunCheckbox.checked) updatePreview();
        alert('ZIP project imported successfully!');
    });
  }).catch(err => alert('Error reading ZIP file.'));
  event.target.value = '';
}

// Fullscreen for the whole page
const fullscreenBtn = document.getElementById('fullscreenBtn');
fullscreenBtn.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    fullscreenBtn.textContent = "⤢ Exit Fullscreen";
  } else {
    document.exitFullscreen();
    fullscreenBtn.textContent = "⛶ Fullscreen Mode";
  }
});

updateLineNumbers();


// ===============================================
// ========= CONFIRM ON CLOSE IF UNSAVED =========
// ===============================================
window.addEventListener('beforeunload', function (e) {
    if (hasUnsavedChanges) {
        // Cancel the event
        e.preventDefault();
        // Chrome requires returnValue to be set
        e.returnValue = '';
        // Most browsers will show a generic message, but returning one is good practice
        return 'Are you sure you want to leave? Your changes may not be saved.';
    }
});


// =======================================================
// ========= COLLABORATION & PREVIEW FULLSCREEN CODE =====
// =======================================================

// --- Element Selectors ---
const collabBtn = document.getElementById('collabBtn');
const collabModal = document.getElementById('collabModal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalDoneBtn = document.getElementById('modalDoneBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
const typingIndicatorEl = document.getElementById('typingIndicator');
const previewFullscreenBtn = document.getElementById('previewFullscreenBtn');
const previewIframe = document.getElementById('output');

// --- Global Variables ---
let sessionData = {};
let typingTimer;
let myInfo = {}; 

// --- Event Listeners ---
closeModalBtn.addEventListener('click', closeModal);
collabBtn.addEventListener('click', startCollaboration);
window.addEventListener('load', checkForSession);
window.addEventListener('storage', handleStorageChange);
previewFullscreenBtn.addEventListener('click', togglePreviewFullscreen);
document.addEventListener('fullscreenchange', updateFullscreenButtonState);


// --- Typing Indicator Functions ---
function announceTyping(activeEditorId) {
    if (!myInfo.name) return;
    clearTimeout(typingTimer);
    const sessionId = localStorage.getItem('activeSessionId');
    if (!sessionId) return;
    
    let session;
    try { session = JSON.parse(localStorage.getItem(sessionId)); if (!session) return; } catch (e) { return; }

    session.typingIndicator = { name: myInfo.name, theme: myInfo.theme, editor: activeEditorId };
    localStorage.setItem(sessionId, JSON.stringify(session));

    typingTimer = setTimeout(() => {
        try {
            session = JSON.parse(localStorage.getItem(sessionId));
            if (!session) return;
            session.typingIndicator = null;
            localStorage.setItem(sessionId, JSON.stringify(session));
        } catch(e) {}
    }, 1500);
}

function updateTypingIndicatorUI(indicator) {
    editors.forEach(editor => { editor.style.boxShadow = 'none'; });
    if (indicator && indicator.name !== myInfo.name) {
        const activeEditor = document.getElementById(indicator.editor);
        if (activeEditor) {
            activeEditor.style.boxShadow = `0 0 0 3px ${indicator.theme} inset`;
            typingIndicatorEl.textContent = `${indicator.name} is typing...`;
            typingIndicatorEl.style.backgroundColor = indicator.theme;
            typingIndicatorEl.style.display = 'block';
        }
    } else {
        typingIndicatorEl.style.display = 'none';
    }
}


// --- Collaboration Host POV ---
function startCollaboration() {
  modalTitle.textContent = 'Start Collaboration';
  modalBody.innerHTML = '<p>Please enter your name to start:</p><input type="text" id="userNameInput" placeholder="Your Name" style="width: 80%; padding: 8px;">';
  collabModal.style.display = 'flex';

  modalDoneBtn.onclick = () => {
    const userName = document.getElementById('userNameInput').value;
    if (!userName.trim()) return alert('Please enter a name.');
    sessionData.host = userName;
    promptForTheme();
  };
}

function promptForTheme() {
  modalTitle.textContent = 'Pick a Theme Color';
  modalBody.innerHTML = `<p>This color will represent you.</p><input type="color" id="userThemeInput" value="#4CAF50">`;

  modalDoneBtn.onclick = () => {
    sessionData.theme = document.getElementById('userThemeInput').value;
    generateSessionLink();
  };
}

function generateSessionLink() {
  const sessionId = 'session-' + Date.now();
  const collabLink = window.location.href.split('#')[0] + '#' + sessionId;

  const initialState = {
    id: sessionId,
    html: document.getElementById('htmlCode').value,
    css: document.getElementById('cssCode').value,
    js: document.getElementById('jsCode').value,
    participants: [{ name: sessionData.host, theme: sessionData.theme }]
  };
  localStorage.setItem(sessionId, JSON.stringify(initialState));
  localStorage.setItem('activeSessionId', sessionId);

  myInfo = { name: sessionData.host, theme: sessionData.theme };

  modalTitle.textContent = 'Share this link with friends!';
  modalBody.innerHTML = `<p>Your session is ready. Copy the link below:</p><input type="text" readonly id="collabLinkInput" value="${collabLink}" style="width: 90%; padding: 8px; text-align: center;">`;
  document.getElementById('modalActions').innerHTML = `<button class="run-button" onclick="copyLink()">Copy Link</button><button class="run-button" onclick="closeModal()">Close</button>`;
  
  startSyncing();
}

function copyLink() {
  document.getElementById('collabLinkInput').select();
  document.execCommand('copy');
  alert('Link copied to clipboard!');
}

function closeModal() {
  collabModal.style.display = 'none';
  document.getElementById('modalActions').innerHTML = `<button id="modalDoneBtn" class="run-button">Done</button>`;
}

// --- Collaboration Friend POV ---
function checkForSession() {
  const sessionId = window.location.hash.substring(1);
  if (sessionId.startsWith('session-')) {
    localStorage.setItem('activeSessionId', sessionId);
    modalTitle.textContent = 'Join Collaboration';
    modalBody.innerHTML = '<p>Please enter your name to join:</p><input type="text" id="userNameInput" placeholder="Your Name" style="width: 80%; padding: 8px;">';
    collabModal.style.display = 'flex';

    modalDoneBtn.onclick = () => {
      const userName = document.getElementById('userNameInput').value;
      if (!userName.trim()) return alert('Please enter a name.');
      promptForThemeAndJoin(userName);
    };
  }
}

function promptForThemeAndJoin(userName) {
    modalTitle.textContent = 'Pick Your Theme Color';
    modalBody.innerHTML = `<input type="color" id="userThemeInput" value="#2196F3">`;
    modalDoneBtn.onclick = () => {
        const userTheme = document.getElementById('userThemeInput').value;
        const sessionId = localStorage.getItem('activeSessionId');
        const sessionStr = localStorage.getItem(sessionId);
        if(sessionStr) {
            myInfo = { name: userName, theme: userTheme };
            const currentSession = JSON.parse(sessionStr);
            currentSession.participants.push({ name: userName, theme: userTheme });
            localStorage.setItem(sessionId, JSON.stringify(currentSession));

            document.getElementById('htmlCode').value = currentSession.html;
            document.getElementById('cssCode').value = currentSession.css;
            document.getElementById('jsCode').value = currentSession.js;
            updatePreview();
            
            alert(`Welcome, ${userName}! You've joined the session.`);
            startSyncing();
        } else {
             alert("Error: Collaboration session not found.");
        }
        closeModal();
    };
}

// --- Syncing Logic ---
function handleCodeChange(event) {
    const sessionId = localStorage.getItem('activeSessionId');
    if (!sessionId) return;
    const currentSessionStr = localStorage.getItem(sessionId);
    if (!currentSessionStr) return;
    let session = JSON.parse(currentSessionStr);

    const key = event.target.id.replace('Code', '');
    session[key] = event.target.value;
    
    localStorage.setItem(sessionId, JSON.stringify(session));
}

function startSyncing() {
    editors.forEach(editor => {
        editor.addEventListener('input', handleCodeChange);
        editor.addEventListener('input', (event) => announceTyping(event.target.id));
    });
}

function handleStorageChange(event) {
    const sessionId = localStorage.getItem('activeSessionId');
    if (event.key === sessionId && event.newValue) {
        const newValue = JSON.parse(event.newValue);
        if (document.getElementById('htmlCode').value !== newValue.html) {
            document.getElementById('htmlCode').value = newValue.html;
        }
        if (document.getElementById('cssCode').value !== newValue.css) {
            document.getElementById('cssCode').value = newValue.css;
        }
        if (document.getElementById('jsCode').value !== newValue.js) {
            document.getElementById('jsCode').value = newValue.js;
        }
        
        updateTypingIndicatorUI(newValue.typingIndicator);
        updateLineNumbers();
        if (autoRunCheckbox.checked) updatePreview();
    }
}

// --- Preview Fullscreen Logic ---
function togglePreviewFullscreen() {
  if (!document.fullscreenElement) {
    if (previewIframe.requestFullscreen) {
      previewIframe.requestFullscreen();
    } else if (previewIframe.webkitRequestFullscreen) { /* Safari */
      previewIframe.webkitRequestFullscreen();
    } else if (previewIframe.msRequestFullscreen) { /* IE11 */
      previewIframe.msRequestFullscreen();
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    }
  }
}

function updateFullscreenButtonState() {
    if (document.fullscreenElement === previewIframe) {
        previewFullscreenBtn.innerHTML = `
            <svg class="btn-icon" viewBox="0 0 24 24">
                <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
            </svg>
            Exit Fullscreen
        `;
        previewFullscreenBtn.title = 'Exit Fullscreen';
    } else {
        previewFullscreenBtn.innerHTML = `
            <svg class="btn-icon" viewBox="0 0 24 24">
                <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
            Fullscreen Preview
        `;
        previewFullscreenBtn.title = 'Enter Fullscreen';
    }
}
</script>

</body>
</html>